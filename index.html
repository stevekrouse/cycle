<!DOCTYPE html>
<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/pieroxy/lz-string/86c39345/libs/lz-string.min.js"></script>
  <title>Cycle</title>

  <style>
    html {
      height: 100%;
    }
    body {
      height: 100%;
      margin: 0px;
      background-color: #fff;
      font-family: sans-serif;
      display: flex;
      align-items: stretch;
      flex-direction: column;
    }
    
    #title {
      font-weight: normal;
      font-size: 25px;
      color: blue;
    }
  </style>
</head>

<body>
  <div id="navbar" style="height:30px; width:calc(100%-10px); padding: 5px; display: flex; justify-content: space-between ">
    <span id="title">Cycle</span>
    <button id="runtimeError" style="display:none; background-color: salmon; border: none">Error</button>
    <a href="./index.html"><button>New Project</button></a>
  </div>

  <div id="container" style="width:100%; flex-grow: 1; display:flex; flex-direction:row; align-items: stretch;">
    <div id="output" style=" width:50%; display:flex; align-items: stretch;">
      <iframe frameBorder="0" src="" id="preview" style="width:100%"></iframe>
    </div>

    <div id="editPane" style="width: 50%; display:flex; align-items: stretch;">
      <iframe frameBorder="0" src="./editor.html" id="blocksEditor" style="height: 100%; width: 100%"></iframe>
    </div>
  </div>

  <script>
    var runtimeError = document.getElementById('runtimeError')
    var preview = document.getElementById('preview')
    var blocksEditor = document.getElementById('blocksEditor')

    var clearError = function() {
      runtimeError.style.display = "none"
    }
      
    $('body').bind('runtimeError', function(event, message) {
      runtimeError.style.display = "inline-block"
      runtimeError.onclick = function() {
        alert(message)
      }
    })
      
    var code = {}
    function run() {
      preview.src = "./output.html";
      
      preview.onload = function() {
        clearError()
        code = blocksEditor.contentWindow.getCode()
        preview.contentWindow.code = code 
      }
    }

    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
        var context = this,
          args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };
    var debouncedRun = debounce(run, 500, false)
    debouncedRun()

    blocksEditor.addEventListener("load", function() {
      if (window.location.hash) {
        blocksEditor.contentWindow.setText(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)))
        debouncedRun()
      }
      $('body').bind('elementChange', function(event, blocklyEvent) {
        debouncedRun()
        window.noUpdate = true
        setTimeout(function() {
          window.noUpdate = false
        }, 500)
        window.location.hash = LZString.compressToEncodedURIComponent(blocksEditor.contentWindow.getText())
      })
    })

    window.addEventListener("hashchange", function() {
      if (!window.noUpdate) {
        blocksEditor.contentWindow.setText(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)))
        debouncedRun()
      }
    });

    var undo = function(event) {
      if ((event.which == 90 || event.keyCode == 90) && event.ctrlKey) {
        if (event.shiftKey) {
          window.history.forward();
        }
        else {
          window.history.back();
        }
      }
    }
    window.addEventListener("keydown", undo)
    preview.contentWindow.addEventListener("keydown", undo)
    blocksEditor.contentWindow.addEventListener("keydown", undo)
  </script>
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-73554466-1', 'auto');
    ga('send', 'pageview');
  </script>

</body>

</html>

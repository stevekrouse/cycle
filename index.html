<!DOCTYPE html>
<html style="height:100%">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

  <title>Cycle</title>
  
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 140%;
    }
    #sorry {
      padding: 1ex;
      background-color: #f9edbe;
      border: solid 1px #f0c36d;
    }
    .CodeMirror {
        height: 100%;
    }
    #title {
        color: blue;
    }
  </style>
</head>
<body style="height:90%">
    <div id="navbar" style="height:5%; width:100%; text-align: center; font-size:30px; margin-top: 7px ">
        <span id="title">Cycle</span>
    </div>

    <div id="container" style="height:100%; width:100%; display:flex; flex-direction:row; ">
        <div id="output" style="height:100%; width:50%">
            <iframe frameBorder="0" src="./frames/output.html" id="preview" style="height:49%; width:100%"></iframe>
            <iframe frameBorder="0" src="./frames/element/index.html" id="elementBlocks" style="height: 49%; width: 100%"></iframe>
        </div>
        
        <div id="editPane" style="height:100%; width: 50%; display:flex; flex-direction:column;"> 
            <iframe frameBorder="0" src="./frames/event/index.html" id="eventBlocks" style="height: 100%;"></iframe>
        </div>
    </div>

  <script>
    var preview = document.getElementById('preview')
    var eventBlocks = document.getElementById('eventBlocks')
    var elementBlocks = document.getElementById('elementBlocks')  
    
    // the key data structure for the whole app
    //  elementEvents :: {ElementID: events}  (where events :: {events, xmlDoc, definitions, variables})
    var elementEvents = {}
    
    var elementCode
    function runElement() {
      preview.src = "./frames/output.html";
      preview.onload = function () {
        elementCode = elementBlocks.contentWindow.getElementCode(elementEvents)
        preview.contentWindow.code = elementCode
      }
    }
    
    function debounce(func, wait, immediate) {
    	var timeout;
    	return function() {
    		var context = this, args = arguments;
    		var later = function() {
    			timeout = null;
    			if (!immediate) func.apply(context, args);
    		};
    		var callNow = immediate && !timeout;
    		clearTimeout(timeout);
    		timeout = setTimeout(later, wait);
    		if (callNow) func.apply(context, args);
    	};
    };
    var debouncedRunElement = debounce(runElement, 500, false)
    debouncedRunElement()
    
    $('body').bind('elementChange', debouncedRunElement)
    
    
    $('body').bind('newElementSelected', function(event, blockId) {
      var selectedEvents = (elementEvents[blockId] || {}).xmlDoc
      eventBlocks.contentWindow.setWorkspace(selectedEvents)
    })
    
    $('body').bind('eventChange', function(event, settings) {
      elementEvents[elementBlocks.contentWindow.selectedElement.id] = settings
      debouncedRunElement()
    })
    
    // ^ combine element settings and children to one settings block 

    // next things TODO for target goal: simple, add-only todo list
    // * set initial val in element
    // * add loops for lists
    
    // after todo list
    // * consider adding events to element children
    // * figure out how props/components could work for todo list
    // *   seperate variables via components
    // * message broadcasting
    // * full todomvc css
    // * refactor things so as to decouple from blocky / vue --> a cycle runtime/AST thingy, should be easier now that we have element/setting & events seperated
    // *   should be similar to the vuejs render object (if not exactly that)

    
    // ideas for new block language / forking blockly
    // * the toolbox lives in the mouse so as to help you understand what's in context/scope
    // * 
    
    // eventually, neccesary features that we don't need now because I can use my imagination
    // * update blockly so things like shadow blocks work
    // * add the word "initial" to setting variables in element
    // * parse string to number
    // * allow multiple kinds of each event
    // * figure out how to add variables for callbacks (similar to how adding a for-loop does)
    // * Objects, create empty, access key, set key, get all keys   
    // * add variable/method definitions to the scope where vue expressions are evaluated
    // * seperate the set_css block into singles
    // * make element / setting variables correspond
    // * when settings (or text) blocks are clicked in elements, make the events show it's parents' (or parent's parent's etcs) events
    
  </script>
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-73554466-1', 'auto');
      ga('send', 'pageview');
  </script>

</body>
</html>
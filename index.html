<!DOCTYPE html>
<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/pieroxy/lz-string/86c39345/libs/lz-string.min.js"></script>
  
  <script src="./vendor/blockly/blockly-compressed.js"></script>
  <script src="./vendor/blockly/blocks_compressed.js"></script>
  <script src="./vendor/blockly/javascript_compressed.js"></script>
  <script src="./vendor/blockly/en.js"></script>

  <script src="./blocks.js"></script>
  <script src="./generator.js"></script>
  
  <title>Cycle</title>

  <style>
    html {
      height: 100%;
    }
    body {
      height: 100%;
      margin: 0px;
      background-color: #fff;
      font-family: sans-serif;
      display: flex;
      align-items: stretch;
      flex-direction: column;
    }
    
    #title {
      font-weight: normal;
      font-size: 25px;
      color: blue;
    }
  </style>
</head>

<body>
  <div id="navbar" style="height:30px; width:calc(100%-10px); padding: 5px; display: flex; justify-content: space-between ">
    <span id="title">Cycle</span>
    <button id="runtimeError" style="display:none; background-color: salmon; border: none">Error</button>
    <a href="./index.html"><button>New Project</button></a>
  </div>

  <div id="container" style="width:100%; flex-grow: 1; display:flex; flex-direction:row; align-items: stretch;">
    <div id="output" style=" width:50%; display:flex; align-items: stretch;">
      <iframe frameBorder="0" src="" id="preview" style="width:100%"></iframe>
    </div>

    <div id="blocksEditor" style="width: 50%; "></div>
    
    <xml id="toolbox" style="display: none;">
      <category name="Elements" colour="20">
        <block type="cycle_container"></block>
        <block type="cycle_text">
          <value name="TEXT">
            <block type="text"></block>
          </value>
        </block>
        <block type="cycle_link"></block>
        <block type="cycle_image"></block>
        <block type="cycle_button"></block>
        <block type="cycle_input"></block>
        <block type="cycle_input">
          <statement name="CHILDREN">
            <block type="variables_set">
              <field name="VAR">inputText</field>
              <value name="VALUE">
                <block type="text">
                  <field name="TEXT"></field>
                </block>
              </value>
              <next>
                <block type="cycle_html_property">
                  <value name="KEY">
                    <block type="text">
                      <field name="TEXT">value</field>
                    </block>
                  </value>
                  <value name="VALUE">
                    <block type="text">
                      <field name="TEXT"></field>
                    </block>
                  </value>
                  <next>
                    <block type="keyup">
                      <statement name="blocks">
                        <block type="variables_set">
                          <field name="VAR">inputText</field>
                          <value name="VALUE">
                            <block type="objects_get">
                              <value name="OBJECT">
                                <block type="objects_get">
                                  <value name="OBJECT">
                                    <block type="variables_get">
                                      <field name="VAR">event</field>
                                    </block>
                                  </value>
                                  <value name="KEY">
                                    <block type="text">
                                      <field name="TEXT">target</field>
                                    </block>
                                  </value>
                                </block>
                              </value>
                              <value name="KEY">
                                <block type="text">
                                  <field name="TEXT">value</field>
                                </block>
                              </value>
                            </block>
                          </value>
                        </block>
                      </statement>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </statement>
        </block>
        <!--list-->
        <!--list element (numbered/bullet/nothing)-->
        <!--heading-->
        <!--text area-->
        <!--table-->
        <!--table row-->
        <!--table cell-->
        <!--code (pre)-->
        <!--embed-->
        <!--spacer-->
        <!--radio buttons-->
        <!--checkboxes-->
        <!--select dropdown-->
        <!--toggle-->
        <!--navbar-->
      </category>
      <category name="Settings" colour="310">
        <block type="set_css">
          <value name="VALUE">
            <block type="text"></block>
          </value>
        </block>
        <block type="cycle_css_property">
          <value name="KEY">
            <block type="text"></block>
          </value>
          <value name="VALUE">
            <block type="text"></block>
          </value>
        </block>
        <block type="cycle_html_property">
          <value name="KEY">
            <block type="text"></block>
          </value>
          <value name="VALUE">
            <block type="text"></block>
          </value>
        </block>
      </category>
      <category name="Events" colour="60">
        <block type="load"></block>
        <block type="mousedown"></block>
        <block type="mouseup"></block>
        <block type="dblclick"></block>
        <block type="mouseover"></block>
        <block type="mouseout"></block>
        <block type="keydown"></block>
        <block type="keyup"></block>
        <block type="blur"></block>
        <block type="change"></block>
      </category>
      <category name="Logic" colour="210">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
        <block type="logic_null"></block>
        <block type="logic_ternary"></block>
      </category>
      <category name="Control" colour="120">
        <block type="cycle_debugger"></block>
        <block type="controls_repeat_ext">
          <value name="TIMES">
            <block type="math_number">
              <field name="NUM">10</field>
            </block>
          </value>
        </block>
        <block type="controls_whileUntil"></block>
        <block type="controls_for">
          <value name="FROM">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
          <value name="TO">
            <block type="math_number">
              <field name="NUM">10</field>
            </block>
          </value>
          <value name="BY">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
        </block>
        <block type="controls_forEach"></block>
      </category>
      <category name="Math" colour="230">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_single"></block>
        <block type="math_trig"></block>
        <block type="math_constant"></block>
        <block type="math_number_property"></block>
        <block type="math_round"></block>
        <block type="math_on_list"></block>
        <block type="math_modulo"></block>
        <block type="math_constrain">
          <value name="LOW">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
          <value name="HIGH">
            <block type="math_number">
              <field name="NUM">100</field>
            </block>
          </value>
        </block>
        <block type="math_random_int">
          <value name="FROM">
            <block type="math_number">
              <field name="NUM">1</field>
            </block>
          </value>
          <value name="TO">
            <block type="math_number">
              <field name="NUM">100</field>
            </block>
          </value>
        </block>
        <block type="math_random_float"></block>
      </category>
      <category name="Text" colour="165">
        <block type="text"></block>
        <block type="text_print"></block>
        <block type="text_prompt_ext">
          <value name="TEXT">
            <block type="text"></block>
          </value>
        </block>
        <block type="text_join"></block>
        <block type="text_append">
          <value name="TEXT">
            <block type="text"></block>
          </value>
        </block>
        <block type="text_length"></block>
        <block type="text_isEmpty"></block>
        <block type="text_indexOf">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">text</field>
            </block>
          </value>
        </block>
        <block type="text_charAt">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">text</field>
            </block>
          </value>
        </block>
        <block type="text_getSubstring">
          <value name="STRING">
            <block type="variables_get">
              <field name="VAR">text</field>
            </block>
          </value>
        </block>
        <block type="text_changeCase"></block>
        <block type="text_trim"></block>
      </category>
      <category name="Lists" colour="255">
        <block type="lists_create_empty"></block>
        <block type="lists_create_with"></block>
        <block type="lists_repeat">
          <value name="NUM">
            <block type="math_number">
              <field name="NUM">5</field>
            </block>
          </value>
        </block>
        <block type="lists_length"></block>
        <block type="lists_isEmpty"></block>
        <block type="lists_indexOf">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">list</field>
            </block>
          </value>
        </block>
        <block type="lists_getIndex">
          <value name="VALUE">
            <block type="variables_get">
              <field name="VAR">list</field>
            </block>
          </value>
        </block>
        <block type="lists_setIndex">
          <value name="LIST">
            <block type="variables_get">
              <field name="VAR">list</field>
            </block>
          </value>
        </block>
        <block type="lists_getSublist">
          <value name="LIST">
            <block type="variables_get">
              <field name="VAR">list</field>
            </block>
          </value>
        </block>
      </category>
      <category name="Objects" colour="240">
        <block type="objects_create_empty"></block>
        <block type="objects_create_with"></block>
        <block type="objects_keys"></block>
        <block type="objects_get">
          <value name="KEY">
            <block type="text"></block>
          </value>
        </block>
        <block type="objects_set"></block>
        <block type="objects_copy"></block>
        <block type="objects_clone_with"></block>
      </category>
      <category name="Colour" colour="20">
        <block type="colour_picker"></block>
        <block type="colour_random"></block>
        <block type="colour_rgb">
          <value name="RED">
            <block type="math_number">
              <field name="NUM">100</field>
            </block>
          </value>
          <value name="GREEN">
            <block type="math_number">
              <field name="NUM">50</field>
            </block>
          </value>
          <value name="BLUE">
            <block type="math_number">
              <field name="NUM">0</field>
            </block>
          </value>
        </block>
        <block type="colour_blend">
          <value name="COLOUR1">
            <block type="colour_picker">
              <field name="COLOUR">#ff0000</field>
            </block>
          </value>
          <value name="COLOUR2">
            <block type="colour_picker">
              <field name="COLOUR">#3333ff</field>
            </block>
          </value>
          <value name="RATIO">
            <block type="math_number">
              <field name="NUM">0.5</field>
            </block>
          </value>
        </block>
      </category>
      <category name="Variables" colour="330" custom="VARIABLE"></category>
      <category name="Functions" colour="290" custom="PROCEDURE"></category>
      <category name="Custom Elements" colour="0">
        <block type="cycle_create_element">
        </block>
        <block type="cycle_custom_element">
          <value name="NAME">
            <block type="text"></block>
          </value>
        </block>
        <block type="cycle_create_input">
        </block>
        <block type="cycle_add_input">
          <value name="VALUE">
            <block type="text"></block>
          </value>
        </block>
        <block type="cycle_emit">
          <value name="NAME">
            <block type="text"></block>
          </value>
        </block>
        <block type="cycle_custom_event">
          <value name="NAME">
            <block type="text"></block>
          </value>
        </block>
      </category>
      <category name="Firebase" colour="200">
        <block type="cycle_include_script">
          <statement name="CHILDREN">
            <block type="firebase_initialize_app"></block>
          </statement>
        </block>
        
        <block type="firebase_set">
          <value name="REF">
            <block type="text"></block>
          </value>
          <value name="VALUE">
            <block type="objects_create_with"></block>
          </value>
        </block>
        <block type="firebase_add_to_list">
          <value name="REF">
            <block type="text"></block>
          </value>
          <value name="VALUE">
            <block type="objects_create_with"></block>
          </value>
        </block>
        <block type="firebase_get">
          <value name="REF">
            <block type="text"></block>
          </value>
        </block>
        <block type="firebase_delete">
          <value name="REF">
            <block type="text"></block>
          </value>
        </block>
      </category>
    </xml>

    <xml id="elementStartingBlocks">
        <block type="cycle_page" deletable="false" movable="false" x="0" y="10"></block>
      </xml>
  </div>

  <script>
    Blockly.BlockSvg.START_HAT = true;

    var workspace = Blockly.inject('blocksEditor', {
      toolbox: document.getElementById("toolbox"),
      collapse: true,
      comments: true,
      maxBlocks: Infinity,
      trashcan: true,
      horizontalLayout: false,
      toolboxPosition: 'start',
      css: true,
      media: './vendor/blockly/media/',
      rtl: false,
      scrollbars: true,
      sounds: true,
      oneBasedIndex: true,
      zoom: {
        controls: true,
        wheel: false,
        startScale: 1.0,
        maxScale: 3,
        minScale: 0.3,
        scaleSpeed: 1.2
      },
    });

    Blockly.Xml.domToWorkspace(document.getElementById('elementStartingBlocks'), workspace);

    workspace.addChangeListener(function(event) {
      if (event instanceof Blockly.Events.Ui) {
        if (event.element == "selected") {
          if (event.oldValue) {
            var element = $(preview.contentWindow.document).find("*").filterByData('block-id', event.oldValue)
            
            element.css('border', element.data('old-border'))
            element.css('opacity', element.data('old-opacity'))
          }
          if (event.newValue) {
            var element = $(preview.contentWindow.document).find("*").filterByData('block-id', event.newValue)
            
            // store default styles
            element.data('old-border', element.css("border") || "none")
            element.data('old-opacity', element.css("opacity") || "1")
            
            // highlight element
            element.css('border', "2px solid #4d90fe")
            element.css('opacity', "0.7")
            
            
          }
        }
      }
      else {
        debouncedRun()
        window.noUpdate = true
        setTimeout(function() {
          window.noUpdate = false
        }, 500)
        window.location.hash = LZString.compressToEncodedURIComponent(getText())
        }
    })

    function getCode() {
      Blockly.JavaScript.init(workspace);
      var blocks = workspace.getTopBlocks(true);

      var page;
      var components = []
      var compileErrors = []
      for (var b = 0; b < blocks.length; b++) {
        var block = blocks[b];
        if ("cycle_page" == block.type) {
          try {
            page = workspaceData(block)
          }
          catch(e) {
            if (e.message.includes("Cannot read property 'call' of undefined")) {
              compileErrors.push(new Error("You cannot have elements or settings inside of events."))
            } else if (e.message == "a.replace is not a function") {
              compileErrors.push(new Error('You cannot put an event inside another event.'))
            } else {
              compileErrors.push(e)
            }
          }
        }
        else if (block.type.includes("procedures_")) {
          try {
            Blockly.JavaScript.blockToCode(block) // evaluated for the side-effect of having the function definition in Blockly.JavaScript.definitions_
          } catch (e) {
            compileErrors.push(e)
          }
        }
        else if (block.type == "cycle_create_element") {
          try {
            components.push(workspaceData(block))
          }
          catch (e) {
            compileErrors.push(e)
          }
        }
      }

      var definitions = {}
      Object.keys(Blockly.JavaScript.definitions_).forEach(function(name) {
        if (name != "variables") {
          var nameWithoutLeadingPercent = name.slice(1)
          var definition = Blockly.JavaScript.definitions_[name]
          definitions[nameWithoutLeadingPercent] = definition
        }
      })

      return {
        page: page,
        blocks: blocks,
        definitions: definitions,
        components: components,
        compileErrors: compileErrors
      }
    }

    function getText() {
      return Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace));
    }

    function setText(text) {
      workspace.clear()
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(text), workspace);
    }
    
    var runtimeError = document.getElementById('runtimeError')
    var preview = document.getElementById('preview')
    var blocksEditor = document.getElementById('blocksEditor')

    var clearError = function() {
      runtimeError.style.display = "none"
    }
      
    $('body').bind('runtimeError', function(event, message) {
      runtimeError.style.display = "inline-block"
      runtimeError.onclick = function() {
        alert(message)
      }
    })
      
    var code = {}
    function run() {
      preview.src = "./output.html";
      
      preview.onload = function() {
        clearError()
        code = getCode()
        preview.contentWindow.code = code 
      }
    }

    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
        var context = this,
          args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };
    var debouncedRun = debounce(run, 500, false)
    debouncedRun()

    if (window.location.hash) {
      setText(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)))
      debouncedRun()
    }

    window.addEventListener("hashchange", function() {
      if (!window.noUpdate) {
        setText(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)))
        debouncedRun()
      }
    });
    
    $.fn.filterByData = function(prop, val) {
        return this.filter(
            function() { return this["data-" + prop]==val; }
        );
    }

    var undo = function(event) {
      if ((event.which == 90 || event.keyCode == 90) && event.ctrlKey) {
        if (event.shiftKey) {
          window.history.forward();
        }
        else {
          window.history.back();
        }
      }
    }
    window.addEventListener("keydown", undo)
    preview.contentWindow.addEventListener("keydown", undo)
    addEventListener("keydown", undo)
    
  </script>
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-73554466-1', 'auto');
    ga('send', 'pageview');
  </script>

</body>

</html>

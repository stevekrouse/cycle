<!DOCTYPE html>
<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/pieroxy/lz-string/86c39345/libs/lz-string.min.js"></script>
  
  <script src="./vendor/blockly/blockly-compressed.js"></script>
  <script src="./vendor/blockly/blocks_compressed.js"></script>
  <script src="./vendor/blockly/javascript_compressed.js"></script>
  <script src="./vendor/blockly/en.js"></script>

  <script src="./blocks.js"></script>
  <script src="./generator.js"></script>
  
  <title>Cycle</title>

  <style>
    html {
      height: 100%;
    }
    body {
      height: 100%;
      margin: 0px;
      background-color: #fff;
      font-family: sans-serif;
      display: flex;
      align-items: stretch;
      flex-direction: column;
    }
    
    #title {
      font-weight: normal;
      font-size: 25px;
      color: blue;
    }
  </style>
</head>

<body>
  <div id="navbar" style="height:30px; width:calc(100%-10px); padding: 5px; display: flex; justify-content: space-between ">
    <span id="title">Cycle</span>
    <img onclick="selector=true" style="height:30px" src="https://d0.awsstatic.com/Inspector/Inspector_MCV3_Benefit_IdentifyApplication.png"></img>
    <button id="runtimeError" style="display:none; background-color: salmon; border: none">Error</button>
    <a href="./index.html"><button>New Project</button></a>
  </div>

  <div id="container" style="width:100%; flex-grow: 1; display:flex; flex-direction:row; align-items: stretch;">
    <div id="output" style=" width:50%; display:flex; align-items: stretch;">
      <iframe frameBorder="0" src="" id="preview" style="width:100%"></iframe>
    </div>

    <div id="blocksEditor" style="width: 50%; "></div>
    
    <xml id="elementStartingBlocks" style="display:none">
      <block type="cycle_page" id="1" deletable="false" movable="false" x="0" y="10"><statement name="CHILDREN"><block type="layout_height" id="Z_;h`Tu#1D$/uw$_0=yg"><value name="VALUE"><block type="text" id="@tA^B-r5k2-gdJW]|*1H"><field name="TEXT">100%</field></block></value><next><block type="layout_background_color" id="St|`#QCG?B;vNm$a7r9z"><value name="COLOR"><block type="colour_picker" id="uw=itF/nez?qJAs,gLa}"><field name="COLOUR">#ffffff</field></block></value><next><block type="layout_flex_parent" id="g!-{wcJ*EIra^nqS-pTz"><field name="DIRECTION">column</field><field name="X">center</field><field name="Y">top</field><field name="WRAP">wrap</field><next><block type="cycle_container" id="{[prevIU~[?u.[kji,[4"><statement name="CHILDREN"><block type="font_color" id="17.lb%4Wdjf89A!Qmapk"><value name="COLOR"><block type="colour_picker" id="aWs+UwCEuHW#P,9P2)G1"><field name="COLOUR">#ff6666</field></block></value><next><block type="layout_margin" id="Pg7~z!JRqGNCgf]7@:E_"><field name="BORDER">Top</field><value name="VALUE"><block type="text" id="{)=/xZXeJZmmu2-}.^Qk"><field name="TEXT">100px</field></block></value><next><block type="font_size" id="E-naHXF5e=JZ(a()n:06"><value name="SIZE"><block type="text" id="u}CL0i}l4C$QpRv^%^ed"><field name="TEXT">50px</field></block></value><next><block type="font_family" id="*8%FD`Mk]]NlCN5v;1$["><value name="FONT"><block type="text" id="$`wU:`yC[^J?8g4zzwL}"><field name="TEXT">sans-serif</field></block></value><next><block type="cycle_text" id="o929PCc,t3Y]cNDv=/+9"><value name="TEXT"><block type="text" id="OBk7E:r/w`T:hGF:^NdD"><field name="TEXT">Welcome to Cycle</field></block></value></block></next></block></next></block></next></block></next></block></statement><next><block type="cycle_button" id="yi11R!ix186a]Y[Tv2FX"><statement name="CHILDREN"><block type="layout_background_color" id="KZI1M[Yv%z{6ml.U!A3l"><value name="COLOR"><block type="colour_picker" id="6PV4Tk3/P0)=@*1#ntua"><field name="COLOUR">#ffffff</field></block></value><next><block type="font_color" id="8~HKUjs?g{(i+#WhLw*k"><value name="COLOR"><block type="colour_picker" id="s9GlVxfx[-N,ZSom`YQ%"><field name="COLOUR">#666666</field></block></value><next><block type="layout_border" id="J#UXaRvd;)2`_(2e^dX5"><field name="BORDER">all</field><field name="STYLE">solid</field><value name="WIDTH"><block type="text" id="NnWKsrwTy/phW^aNUNxc"><field name="TEXT">2px</field></block></value><value name="COLOR"><block type="colour_picker" id="]bwh`QPt]z?7UZMrK|WL"><field name="COLOUR">#c0c0c0</field></block></value><next><block type="cycle_css_property" id="ym)JSg.rk-^)s7q|bH3V"><value name="KEY"><block type="text" id="5ws689jE!r{84J,})Bvr"><field name="TEXT">outline</field></block></value><value name="VALUE"><block type="text" id=",yaA;^]WD?k^1=QlGby6"><field name="TEXT">none</field></block></value><next><block type="font_size" id="~2B*iPeYKXO*;k`s.H6z"><value name="SIZE"><block type="text" id="m%CDKH)X`Otm2_P8C5|E"><field name="TEXT">30px</field></block></value><next><block type="layout_margin" id="S~DMzr}c/Yt#jmpmw_l("><field name="BORDER">Top</field><value name="VALUE"><block type="text" id="0mr1c^:}{s2,j_Hll4C."><field name="TEXT">40px</field></block></value><next><block type="cycle_text" id="M0b]_Bxpj4_+,)c^}gnl"><value name="TEXT"><block type="text_join" id="gj_5z^Z*#[H)@uJjz/N6"><mutation items="3"></mutation><value name="ADD0"><block type="text" id="bL$v_#YX(zmInkf%%b5s"><field name="TEXT">I've been clicked </field></block></value><value name="ADD1"><block type="variables_get" id=",OZqq%y(~}k)dNy#wM;h"><field name="VAR">clicks</field></block></value><value name="ADD2"><block type="text" id="NWxl1WD[4Hfzj,q`Z8!Q"><field name="TEXT"> times</field></block></value></block></value><next><block type="variables_set" id="5w;Fv/p.7GMMs8i|qOKF"><field name="VAR">clicks</field><value name="VALUE"><block type="math_number" id="eHe3QR|{iIA{l}eVYSL3"><field name="NUM">0</field></block></value><next><block type="mousedown" id="/wdNa!YO=2DnO@Jt}VA:"><statement name="blocks"><block type="math_change" id="iMl0f#x%1^3k}PQ0Id(@"><field name="VAR">clicks</field><value name="DELTA"><shadow type="math_number" id="eb!DcZ/;:+zq;|qC#:R,"><field name="NUM">1</field></shadow></value></block></statement></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block></next></block></next></block></next></block></next></block></statement></block>
    </xml>
  </div>

  <script>
    Blockly.BlockSvg.START_HAT = true;
    
    Blockly.WorkspaceSvg.prototype.scrollToBlock = function(blockId) {
      if (blockId) {
        var block = workspace.getAllBlocks().find(function(b){
          return b.id == blockId
        })
        if (block) {
          this.highlightBlock(blockId)
          this.scrollbar.set(block.getRelativeToSurfaceXY().x, block.getRelativeToSurfaceXY().y);
        }
      }
    };
    function highlightOutputElement$(element){
      if (!element.data('old-border')){
        // store default styles
        element.data('old-border', element.css("border") || "none")
        element.data('old-opacity', element.css("opacity") || "1")
      
        // highlight element
        element.css('border', "2px solid #4d90fe")
        element.css('opacity', "0.7")
      }
    }
    function unhighlightOutputElement$(element){
      if (element.data('old-border')) {
        element.css('border', element.data('old-border'))
        element.css('opacity', element.data('old-opacity')) 
      
        element.data('old-border', null)
        element.data('old-opacity', null)
      }
    }
    
    var selector = false
    $('body').bind('mousedownElement', function(event, element) {
      selector = false
    })
    $('body').bind('mouseoverElement', function(event, element) {
      if (selector) {
        workspace.scrollToBlock(element['data-block-id'])  
        highlightOutputElement$($(element))
      }
    })
    $('body').bind('mouseoutElement', function(event, element) {
      unhighlightOutputElement$($(element))
    })
    
    var workspace
    $.get('./toolbox.xml').done(function(resp){
      workspace = Blockly.inject('blocksEditor', {
        toolbox: resp.firstChild,
        collapse: true,
        comments: true,
        maxBlocks: Infinity,
        trashcan: true,
        horizontalLayout: false,
        toolboxPosition: 'start',
        css: true,
        media: './vendor/blockly/media/',
        rtl: false,
        scrollbars: true,
        sounds: true,
        oneBasedIndex: true,
        zoom: {
          controls: true,
          wheel: false,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2
        },
      });
      Blockly.Xml.domToWorkspace(document.getElementById('elementStartingBlocks'), workspace);  
      
      workspace.addChangeListener(function(event) {
        if (event instanceof Blockly.Events.Ui) {
          if (event.element == "selected") {
            if (event.oldValue) {
              var element = $(preview.contentWindow.document).find("*").filterByData('block-id', event.oldValue)
              
              unhighlightOutputElement$(element)

            }
            if (event.newValue) {
              var element = $(preview.contentWindow.document).find("*").filterByData('block-id', event.newValue)
              highlightOutputElement$(element)
            }
          }
        }
        else {
          debouncedRun()
          window.noUpdate = true
          setTimeout(function() {
            window.noUpdate = false
          }, 500)
          window.location.hash = LZString.compressToEncodedURIComponent(getText())
          }
      })
      debouncedRun()

      if (window.location.hash) {
        setText(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)))
        debouncedRun()
      }
  
      window.addEventListener("hashchange", function() {
        if (!window.noUpdate) {
          setText(LZString.decompressFromEncodedURIComponent(window.location.hash.substring(1)))
          debouncedRun()
        }
      });
    })

    function getCode() {
      Blockly.JavaScript.init(workspace);
      var blocks = workspace.getTopBlocks(true);

      var page;
      var components = []
      var compileErrors = []
      for (var b = 0; b < blocks.length; b++) {
        var block = blocks[b];
        if ("cycle_page" == block.type) {
          try {
            page = workspaceData(block)
          }
          catch(e) {
            if (e.message.includes("Cannot read property 'call' of undefined")) {
              compileErrors.push(new Error("You cannot have elements or settings inside of events."))
            } else if (e.message == "a.replace is not a function") {
              compileErrors.push(new Error('You cannot put an event inside another event.'))
            } else {
              compileErrors.push(e)
            }
          }
        }
        else if (block.type.includes("procedures_")) {
          try {
            Blockly.JavaScript.blockToCode(block) // evaluated for the side-effect of having the function definition in Blockly.JavaScript.definitions_
          } catch (e) {
            compileErrors.push(e)
          }
        }
        else if (block.type == "cycle_create_element") {
          try {
            components.push(workspaceData(block))
          }
          catch (e) {
            compileErrors.push(e)
          }
        }
      }

      var definitions = {}
      Object.keys(Blockly.JavaScript.definitions_).forEach(function(name) {
        if (name != "variables") {
          var nameWithoutLeadingPercent = name.slice(1)
          var definition = Blockly.JavaScript.definitions_[name]
          definitions[nameWithoutLeadingPercent] = definition
        }
      })

      return {
        page: page,
        blocks: blocks,
        definitions: definitions,
        components: components,
        compileErrors: compileErrors
      }
    }

    function getText() {
      return Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace));
    }

    function setText(text) {
      workspace.clear()
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(text), workspace);
    }
    
    var runtimeError = document.getElementById('runtimeError')
    var preview = document.getElementById('preview')
    var blocksEditor = document.getElementById('blocksEditor')

    var clearError = function() {
      runtimeError.style.display = "none"
    }
      
    $('body').bind('runtimeError', function(event, message) {
      runtimeError.style.display = "inline-block"
      runtimeError.onclick = function() {
        alert(message)
      }
    })
      
    var code = {}
    function run() {
      preview.src = "./output.html";
      
      preview.onload = function() {
        clearError()
        code = getCode()
        preview.contentWindow.code = code 
      }
    }

    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
        var context = this,
          args = arguments;
        var later = function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        };
        var callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(context, args);
      };
    };
    var debouncedRun = debounce(run, 500, false)
    
    $.fn.filterByData = function(prop, val) {
        return this.filter(
            function() { return this["data-" + prop]==val; }
        );
    }

    var undo = function(event) {
      if ((event.which == 90 || event.keyCode == 90) && event.ctrlKey) {
        if (event.shiftKey) {
          window.history.forward();
        }
        else {
          window.history.back();
        }
      }
    }
    window.addEventListener("keydown", undo)
    preview.contentWindow.addEventListener("keydown", undo)
    addEventListener("keydown", undo)
    
  </script>
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-73554466-1', 'auto');
    ga('send', 'pageview');
  </script>

</body>

</html>

<script type="text/javascript" src="https://unpkg.com/vue/dist/vue.js"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<body>
  <div id="page"></div>
</body>
<script>
  window.loads = []
  function scopeVaribles(funcString, keyword, variables, boundVariables) {
    var result = funcString
    variables.forEach(function(variable) {
      result = result.split(variable).join(keyword + "." + variable)
    })
    var boundKeys = Object.keys(boundVariables)
    boundKeys.forEach(function(variable) {
      result = result.split(variable).join(JSON.stringify(boundVariables[variable]))
    })
    return result
  }
  
  function parseCodeToVueRender(code, variables, boundVariables){
    return function(h) {
      return parseChildrenToRender(this, h, code, variables, boundVariables)
    }
  }
  function parseChildrenToRender(self, h, code, variables, boundVariables){
    if (code == null) {
      return null 
    } else if (typeof code == "string") {
      return eval(scopeVaribles(code, "self", variables, boundVariables))  
    } else if (code.attributes.repeat) {
      return h(
        "div", // containter for all the repeats
        eval(scopeVaribles(code.attributes.repeat.list, "self", variables, boundVariables)).map(function (item) {
          var boundVariablesCopy = JSON.parse(JSON.stringify(boundVariables))
          boundVariablesCopy[code.attributes.repeat.iterator] = item
          return h(
            "div",
            scopeAttributes(code.attributes, self, variables, boundVariablesCopy),
            code.children.map(function(child) {
              return parseChildrenToRender(self, h, child, variables, boundVariablesCopy)
            })
          )
        })
      )
    } else if (code.attributes.if) {
      for (var i = 0; i < code.attributes.if.branches.length; i++) {
        var branch = code.attributes.if.branches[i]
        var condition = eval(scopeVaribles(branch.conditionString, "self", variables, boundVariables))
        if (condition) {
          return h(
            "div",
            scopeAttributes(code.attributes, self, variables, boundVariables), 
            branch.doCode.map(function(child) {
              return parseChildrenToRender(self, h, child, variables, boundVariables)
            })
          )
        }
      }
      if (code.attributes.if.else_) {
        return h(
          "div",
          scopeAttributes(code.attributes, self, variables, boundVariables), 
          code.attributes.if.else_.map(function(child) {
            return parseChildrenToRender(self, h, child, variables, boundVariables)
          })
        )
      }
    } else {
      return h(
        code.tagType,
        scopeAttributes(code.attributes, self, variables, boundVariables),
        code.children.map(function(child) {
          return parseChildrenToRender(self, h, child, variables, boundVariables)
        })
      )
    }
  }
  function scopeAttributes(attributes, self, variables, boundVariables){
    var attributes = JSON.parse(JSON.stringify(attributes))

    attributes.onStrings = attributes.onStrings || {} 
    var onKeys = Object.keys(attributes.onStrings)
    attributes.on = {}
    onKeys.forEach(function(key) {
      attributes.on[key] = new Function("event", scopeVaribles(attributes.onStrings[key], "this", variables, boundVariables)).bind(self)
    })
    // TODO the following two lines seem problematic...
    window.loads.push(attributes.on["load"])

    var domPropsStrings = attributes.domPropsStrings || {}
    var domPropsKeys = Object.keys(domPropsStrings)
    attributes.domProps = {}
    domPropsKeys.forEach(function(key) {
      attributes.domProps[key] = eval(attributes.domPropsStrings[key]) // TODO scope this after we figure out how to get self.inputText un-hardcoded
    })
    
    var styleStrings = attributes.styleStrings || {}
    var styleKeys = Object.keys(styleStrings)
    attributes.style = {}
    styleKeys.forEach(function(key) {
      attributes.style[key] = eval(scopeVaribles(attributes.styleStrings[key], "self", variables, boundVariables))
    })
    
    return attributes
  }
  
  function collectData(code) { return collectDataHelper(code, {}) }
  function collectDataHelper(code, collection) {
    if (!code || typeof code == "string") {
      return {}
    } else {
      code.attributes.data = code.attributes.data || {}
      var dataKeys = Object.keys(code.attributes.data)
      dataKeys.forEach(function(key) {
        collection[key] = code.attributes.data[key]
      })
      code.children = code.children || []
      code.children.forEach(function(child) {
        collectDataHelper(child, collection)
      })
      return collection
    }
  }
  
  var app
  function run(){
    var data = collectData(window.code)
    if (window.code){
       app = new Vue({
        el: '#page',
        render: parseCodeToVueRender(window.code, Object.keys(data), {}),
        data: data,
        mounted: function () {
          this.$nextTick(function () {
            window.loads.forEach(function(func) { func && func() })
          })
        }
      // props: {
      //    
      //   }
      })
    }
  }

  setTimeout(run, 100  ) // timeout to wait for code to be defined on scope
</script>